<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HFS Code Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #3b82f6; --primary-hover: #2563eb; --primary-light: rgba(59, 130, 246, 0.1);
            --bg-primary: #0d1117; --bg-secondary: #161b22; --bg-tertiary: #21262d; --bg-elevated: #30363d;
            --text-primary: #e6edf3; --text-secondary: #8b949e; --text-muted: #6e7681;
            --border: #30363d; --border-hover: #484f58;
            --success: #3fb950; --success-bg: rgba(63, 185, 80, 0.1);
            --error: #f85149; --error-bg: rgba(248, 81, 73, 0.1);
            --warning: #d29922; --warning-bg: rgba(210, 153, 34, 0.1);
            --space-1: 4px; --space-2: 8px; --space-3: 12px; --space-4: 16px; --space-5: 20px; --space-6: 24px; --space-8: 32px;
            --transition-fast: 150ms ease; --transition-normal: 200ms ease;
            --radius-sm: 6px; --radius-md: 8px; --radius-lg: 12px;
            --sidebar-width: 240px; --topbar-height: 48px;
        }
        html { font-size: 14px; -webkit-font-smoothing: antialiased; height: 100%; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.5; height: 100%; overflow-x: hidden; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
        body.drawer-open { overflow: hidden; position: fixed; width: 100%; }
        .app-container { display: flex; min-height: 100%; }
        
        /* Sidebar */
        .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: var(--sidebar-width); background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 200; transition: transform var(--transition-normal); }
        .sidebar-close { display: none; position: absolute; top: var(--space-3); right: var(--space-3); width: 44px; height: 44px; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; border-radius: var(--radius-sm); font-size: 18px; align-items: center; justify-content: center; }
        .sidebar-close:hover { background: var(--bg-tertiary); }
        .sidebar-header { padding: var(--space-4); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: var(--space-3); }
        .logo-icon { width: 28px; height: 28px; background: var(--primary); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: white; }
        .logo-text { font-size: 15px; font-weight: 700; color: var(--text-primary); }
        .sidebar-nav { flex: 1; padding: var(--space-2); overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .nav-group-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); padding: var(--space-3) var(--space-3) var(--space-2); margin-top: var(--space-2); }
        .nav-group-label:first-child { margin-top: 0; }
        .nav-item { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3); border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; transition: all var(--transition-fast); font-size: 13px; font-weight: 500; margin-bottom: 2px; min-height: 44px; }
        .nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-icon { width: 18px; text-align: center; font-size: 14px; }
        .sidebar-footer { padding: var(--space-3); border-top: 1px solid var(--border); }
        .status-badge { display: inline-flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-3); background: var(--success-bg); border-radius: var(--radius-sm); font-size: 11px; color: var(--success); font-weight: 500; }
        .status-dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Drawer Overlay */
        .drawer-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 199; opacity: 0; pointer-events: none; transition: opacity var(--transition-normal); -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px); }
        .drawer-overlay.active { display: block; opacity: 1; pointer-events: auto; }
        /* Main Content */
        .main { flex: 1; margin-left: var(--sidebar-width); display: flex; flex-direction: column; min-height: 100vh; min-height: 100dvh; }
        .topbar { height: var(--topbar-height); background: var(--bg-secondary); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 var(--space-4); gap: var(--space-3); position: sticky; top: 0; z-index: 100; }
        .menu-btn { display: none; width: 44px; height: 44px; background: transparent; border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-primary); cursor: pointer; align-items: center; justify-content: center; flex-shrink: 0; }
        .menu-btn svg { width: 18px; height: 18px; }
        .page-title { font-size: 14px; font-weight: 600; color: var(--text-primary); flex: 1; }
        .topbar-actions { display: flex; align-items: center; gap: var(--space-2); }
        .cmd-palette-btn { display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-3); background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-secondary); font-size: 12px; cursor: pointer; min-height: 32px; }
        .cmd-palette-btn:hover { border-color: var(--border-hover); color: var(--text-primary); }
        .kbd { padding: 2px 5px; background: var(--bg-elevated); border-radius: 3px; font-size: 11px; }
        
        /* Content Area */
        .content { flex: 1; padding: var(--space-4); overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .section { display: none; animation: fadeIn var(--transition-normal); }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Cards */
        .card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); }
        .card-header { padding: var(--space-4); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: var(--space-3); }
        .card-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .card-body { padding: var(--space-4); }
        
        /* Segmented Control */
        .segmented-control { display: inline-flex; background: var(--bg-tertiary); border-radius: var(--radius-sm); padding: 2px; gap: 2px; margin-bottom: var(--space-4); overflow-x: auto; max-width: 100%; }
        .segment-btn { padding: var(--space-2) var(--space-3); background: transparent; border: none; border-radius: 4px; color: var(--text-secondary); font-size: 12px; font-weight: 500; cursor: pointer; transition: all var(--transition-fast); white-space: nowrap; min-height: 32px; }
        .segment-btn:hover { color: var(--text-primary); }
        .segment-btn.active { background: var(--primary); color: white; }
        
        /* Editor Toolbar */
        .editor-toolbar { display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-3); background: var(--bg-tertiary); border: 1px solid var(--border); border-bottom: none; border-radius: var(--radius-md) var(--radius-md) 0 0; flex-wrap: wrap; }
        .toolbar-btn { padding: var(--space-2) var(--space-3); background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-secondary); font-size: 11px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: var(--space-1); min-height: 28px; transition: all var(--transition-fast); }
        .toolbar-btn:hover { background: var(--bg-elevated); color: var(--text-primary); }
        .toolbar-divider { width: 1px; height: 20px; background: var(--border); margin: 0 var(--space-1); }
        .toolbar-spacer { flex: 1; }
        
        /* Editor */
        .editor-wrapper { border: 1px solid var(--border); border-top: none; border-radius: 0 0 var(--radius-md) var(--radius-md); overflow: hidden; }
        .editor-container { height: 350px; }
        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--space-2); padding: var(--space-3) var(--space-4); border-radius: var(--radius-sm); font-size: 13px; font-weight: 500; cursor: pointer; transition: all var(--transition-fast); border: none; min-height: 44px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-hover); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover:not(:disabled) { background: var(--bg-elevated); border-color: var(--border-hover); }
        .btn-success { background: var(--success); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-icon { font-size: 14px; }
        .btn-group { display: flex; gap: var(--space-2); flex-wrap: wrap; margin-top: var(--space-4); }
        
        /* Output */
        .output-wrapper { margin-top: var(--space-4); position: relative; }
        .output-label { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-2); display: flex; align-items: center; gap: var(--space-2); }
        .output-panel { background: var(--bg-primary); border: 1px solid var(--border); border-radius: var(--radius-md); padding: var(--space-3); font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.6; max-height: 250px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; color: var(--text-secondary); -webkit-overflow-scrolling: touch; }
        .output-panel.success { border-color: var(--success); }
        .output-panel.error { border-color: var(--error); }
        
        /* AI Analyze Button */
        .ai-analyze-btn { display: none; margin-top: var(--space-2); padding: var(--space-2) var(--space-3); background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border: none; border-radius: var(--radius-sm); color: white; font-size: 12px; font-weight: 500; cursor: pointer; align-items: center; gap: var(--space-2); min-height: 36px; }
        .ai-analyze-btn.visible { display: inline-flex; }
        
        /* Form */
        .form-group { margin-bottom: var(--space-4); }
        .form-label { display: block; font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: var(--space-2); }
        .form-input, .form-textarea, .form-select { width: 100%; padding: var(--space-3); background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 13px; font-family: inherit; transition: all var(--transition-fast); min-height: 44px; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--primary); }
        .form-textarea { font-family: 'JetBrains Mono', monospace; font-size: 12px; resize: vertical; min-height: 120px; }
        .form-select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238b949e' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 40px; }
        
        /* Models */
        .model-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: var(--space-2); margin-bottom: var(--space-4); }
        .model-card { padding: var(--space-3); background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; transition: all var(--transition-fast); min-height: 44px; }
        .model-card:hover { border-color: var(--border-hover); }
        .model-card.active { border-color: var(--primary); background: var(--primary-light); }
        .model-name { font-size: 12px; font-weight: 600; color: var(--text-primary); }
        .model-desc { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
        /* Chat */
        .chat-container { border: 1px solid var(--border); border-radius: var(--radius-md); display: flex; flex-direction: column; height: 400px; overflow: hidden; }
        .chat-messages { flex: 1; overflow-y: auto; padding: var(--space-3); background: var(--bg-primary); -webkit-overflow-scrolling: touch; }
        .chat-msg { margin-bottom: var(--space-3); max-width: 85%; }
        .chat-msg.user { margin-left: auto; }
        .chat-bubble { padding: var(--space-3); border-radius: var(--radius-md); font-size: 13px; line-height: 1.5; }
        .chat-msg.user .chat-bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .chat-msg.ai .chat-bubble { background: var(--bg-tertiary); color: var(--text-primary); border-bottom-left-radius: 4px; }
        .chat-input-row { display: flex; gap: var(--space-2); padding: var(--space-3); background: var(--bg-secondary); border-top: 1px solid var(--border); }
        .chat-input-row .form-input { flex: 1; }
        
        /* Toast */
        .toast-container { position: fixed; bottom: var(--space-4); right: var(--space-4); z-index: 1000; display: flex; flex-direction: column; gap: var(--space-2); }
        .toast { padding: var(--space-3) var(--space-4); background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--text-primary); font-size: 13px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); animation: toastIn 0.2s ease; display: flex; align-items: center; gap: var(--space-2); }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--error); }
        .toast.warning { border-color: var(--warning); }
        @keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Command Palette */
        .cmd-palette-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 500; align-items: flex-start; justify-content: center; padding-top: 15vh; }
        .cmd-palette-overlay.active { display: flex; }
        .cmd-palette { width: 90%; max-width: 500px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4); }
        .cmd-palette-input { width: 100%; padding: var(--space-4); background: transparent; border: none; border-bottom: 1px solid var(--border); color: var(--text-primary); font-size: 15px; outline: none; }
        .cmd-palette-input::placeholder { color: var(--text-muted); }
        .cmd-palette-list { max-height: 300px; overflow-y: auto; padding: var(--space-2); }
        .cmd-item { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3); border-radius: var(--radius-sm); cursor: pointer; transition: background var(--transition-fast); }
        .cmd-item:hover, .cmd-item.selected { background: var(--bg-tertiary); }
        .cmd-item-icon { font-size: 14px; width: 20px; text-align: center; }
        .cmd-item-label { font-size: 13px; color: var(--text-primary); flex: 1; }
        .cmd-item-shortcut { font-size: 11px; color: var(--text-muted); }
        
        /* AI Panel */
        .ai-panel-overlay { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 400; }
        .ai-panel-overlay.active { display: block; }
        .ai-panel { position: fixed; right: 0; top: 0; bottom: 0; width: 400px; max-width: 90vw; background: var(--bg-secondary); border-left: 1px solid var(--border); z-index: 401; display: flex; flex-direction: column; transform: translateX(100%); transition: transform var(--transition-normal); }
        .ai-panel.open { transform: translateX(0); }
        .ai-panel-header { padding: var(--space-4); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .ai-panel-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: var(--space-2); }
        .ai-panel-close { width: 32px; height: 32px; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; border-radius: var(--radius-sm); font-size: 16px; }
        .ai-panel-close:hover { background: var(--bg-tertiary); }
        .ai-panel-body { flex: 1; overflow-y: auto; padding: var(--space-4); -webkit-overflow-scrolling: touch; }
        .ai-section { margin-bottom: var(--space-4); }
        .ai-section-title { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: var(--space-2); }
        .ai-section-content { background: var(--bg-tertiary); border-radius: var(--radius-sm); padding: var(--space-3); font-size: 13px; line-height: 1.6; }
        .ai-fix-cmd { display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-3); background: var(--bg-primary); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: var(--space-2); cursor: pointer; transition: all var(--transition-fast); }
        .ai-fix-cmd:hover { border-color: var(--primary); background: var(--primary-light); }
        .ai-fix-cmd-text { flex: 1; font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text-primary); }
        .ai-fix-cmd-run { font-size: 12px; color: var(--primary); }
        .risk-badge { padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
        .risk-safe { background: var(--success-bg); color: var(--success); }
        .risk-medium { background: var(--warning-bg); color: var(--warning); }
        .risk-risky { background: var(--error-bg); color: var(--error); }
        .ai-panel-footer { padding: var(--space-3); border-top: 1px solid var(--border); }
        .ai-cmd-input { display: flex; gap: var(--space-2); }
        .ai-cmd-input .form-input { flex: 1; }
        
        /* Preview */
        .preview-frame { width: 100%; height: 300px; border: 1px solid var(--border); border-radius: var(--radius-md); background: white; }
        
        /* Spinner & Skeleton */
        .spinner { width: 14px; height: 14px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: white; animation: spin 0.7s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .skeleton { background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-elevated) 50%, var(--bg-tertiary) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: var(--radius-sm); }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* Alerts */
        .alert { padding: var(--space-3); border-radius: var(--radius-sm); margin-bottom: var(--space-4); font-size: 12px; display: flex; align-items: flex-start; gap: var(--space-2); }
        .alert-info { background: var(--primary-light); color: var(--primary); }
        .alert-warning { background: var(--warning-bg); color: var(--warning); }
        .alert-error { background: var(--error-bg); color: var(--error); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }
        /* Mobile */
        @media (max-width: 768px) {
            :root { --sidebar-width: 280px; }
            .sidebar { transform: translateX(-100%); }
            .sidebar[role="dialog"] { max-height: 100dvh; overflow-y: auto; }
            .sidebar.open { transform: translateX(0); }
            .sidebar-close { display: flex; }
            .drawer-overlay { display: block; opacity: 0; pointer-events: none; }
            .drawer-overlay.active { opacity: 1; pointer-events: auto; }
            .main { margin-left: 0; }
            .menu-btn { display: flex; }
            .content { padding: var(--space-3); }
            .card-body { padding: var(--space-3); }
            .editor-container { height: 280px; }
            .btn-group { flex-direction: column; }
            .btn-group .btn { width: 100%; }
            .model-grid { grid-template-columns: 1fr; }
            .chat-container { height: 350px; }
            .ai-panel { width: 100%; max-width: 100%; }
            .cmd-palette { margin-top: var(--space-4); }
            .topbar-actions .kbd { display: none; }
            .editor-toolbar { overflow-x: auto; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; }
        }
        @media (max-width: 480px) {
            .segmented-control { width: 100%; }
            .segment-btn { flex: 1; text-align: center; }
            .topbar { padding: 0 var(--space-3); }
            .page-title { font-size: 13px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Drawer Overlay -->
        <div class="drawer-overlay" id="drawerOverlay"></div>
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar" role="dialog" aria-modal="true" aria-label="Navigation menu">
            <button class="sidebar-close" id="sidebarClose" aria-label="Close menu">√ó</button>
            <div class="sidebar-header">
                <div class="logo-icon">‚ö°</div>
                <span class="logo-text">HFS Code</span>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-group-label">Workspace</div>
                <div class="nav-item active" data-section="editor">
                    <span class="nav-icon">üìù</span><span>Code Editor</span>
                </div>
                <div class="nav-item" data-section="terminal">
                    <span class="nav-icon">üíª</span><span>Terminal</span>
                </div>
                
                <div class="nav-group-label">Languages</div>
                <div class="nav-item" data-section="python">
                    <span class="nav-icon">üêç</span><span>Python</span>
                </div>
                <div class="nav-item" data-section="javascript">
                    <span class="nav-icon">üìú</span><span>JavaScript</span>
                </div>
                
                <div class="nav-group-label">AI Tools</div>
                <div class="nav-item" data-section="ai-chat">
                    <span class="nav-icon">ü§ñ</span><span>AI Assistant</span>
                </div>
                
                <div class="nav-group-label">Utilities</div>
                <div class="nav-item" data-section="files">
                    <span class="nav-icon">üìÅ</span><span>Files</span>
                </div>
                <div class="nav-item" data-section="api-test">
                    <span class="nav-icon">üåê</span><span>API Tester</span>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="status-badge">
                    <span class="status-dot"></span>
                    <span>System Online</span>
                </div>
            </div>
        </aside>
        <!-- Main Content -->
        <main class="main">
            <!-- Top Bar -->
            <header class="topbar">
                <button class="menu-btn" id="menuBtn" aria-label="Open menu">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <h1 class="page-title" id="pageTitle">Code Editor</h1>
                <div class="topbar-actions">
                    <button class="cmd-palette-btn" id="cmdPaletteBtn">
                        <span>‚åò</span>
                        <span class="kbd">Ctrl+K</span>
                    </button>
                </div>
            </header>
            
            <!-- Content -->
            <div class="content">
                <!-- Editor Section -->
                <section class="section active" id="editor">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Code Editor</span>
                        </div>
                        <div class="card-body">
                            <div class="segmented-control" id="langSelector">
                                <button class="segment-btn active" data-lang="python">Python</button>
                                <button class="segment-btn" data-lang="javascript">JavaScript</button>
                                <button class="segment-btn" data-lang="html">HTML</button>
                                <button class="segment-btn" data-lang="css">CSS</button>
                                <button class="segment-btn" data-lang="json">JSON</button>
                                <button class="segment-btn" data-lang="bash">Bash</button>
                            </div>
                            
                            <div class="editor-toolbar">
                                <button class="toolbar-btn" id="explainBtn">üí° Explain</button>
                                <button class="toolbar-btn" id="optimizeBtn">‚ö° Optimize</button>
                                <button class="toolbar-btn" id="commentsBtn">üìù Comments</button>
                                <button class="toolbar-btn" id="testsBtn">üß™ Tests</button>
                                <div class="toolbar-divider"></div>
                                <div class="toolbar-spacer"></div>
                                <button class="toolbar-btn" id="copyCodeBtn">üìã Copy</button>
                            </div>
                            
                            <div class="editor-wrapper">
                                <div class="editor-container" id="monacoEditor"></div>
                            </div>
                            
                            <div class="btn-group">
                                <button class="btn btn-primary" id="runBtn">
                                    <span class="btn-icon">‚ñ∂</span> Run Code
                                </button>
                                <button class="btn btn-secondary" id="previewBtn" style="display:none;">
                                    <span class="btn-icon">üëÅ</span> Preview
                                </button>
                                <button class="btn btn-secondary" id="downloadBtn">
                                    <span class="btn-icon">üíæ</span> Download
                                </button>
                                <button class="btn btn-secondary" id="clearBtn">
                                    <span class="btn-icon">üóë</span> Clear
                                </button>
                            </div>
                            
                            <div class="output-wrapper">
                                <div class="output-label">Output</div>
                                <div class="output-panel" id="editorOutput">Click "Run Code" to execute...</div>
                                <button class="ai-analyze-btn" id="editorAiAnalyze">
                                    üîç AI Analyze Error
                                </button>
                            </div>
                            
                            <!-- Preview Frame (for HTML) -->
                            <div id="previewContainer" style="display:none; margin-top: var(--space-4);">
                                <div class="output-label">Preview</div>
                                <iframe class="preview-frame" id="previewFrame" sandbox="allow-scripts"></iframe>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Terminal Section -->
                <section class="section" id="terminal">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Terminal</span>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <span>üìÇ</span>
                                <div><strong>Current Directory:</strong> <span id="terminalPwd">Loading...</span></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Command</label>
                                <input type="text" class="form-input" id="terminalInput" placeholder="ls -la">
                            </div>
                            
                            <button class="btn btn-primary" id="terminalRunBtn">
                                <span class="btn-icon">‚ñ∂</span> Execute
                            </button>
                            
                            <div class="output-wrapper">
                                <div class="output-label">Output</div>
                                <div class="output-panel" id="terminalOutput">Enter a command to see output...</div>
                                <button class="ai-analyze-btn" id="terminalAiAnalyze">
                                    üîç AI Analyze Error
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Python Section -->
                <section class="section" id="python">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Python Executor</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Python Code</label>
                                <textarea class="form-textarea" id="pythonCode" placeholder="import json&#10;&#10;data = {'message': 'Hello'}&#10;print(json.dumps(data, indent=2))"></textarea>
                            </div>
                            
                            <button class="btn btn-primary" id="pythonRunBtn">
                                <span class="btn-icon">‚ñ∂</span> Run Python
                            </button>
                            
                            <div class="output-wrapper">
                                <div class="output-label">Output</div>
                                <div class="output-panel" id="pythonOutput">Click "Run Python" to execute...</div>
                                <button class="ai-analyze-btn" id="pythonAiAnalyze">
                                    üîç AI Analyze Error
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- JavaScript Section -->
                <section class="section" id="javascript">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">JavaScript Executor</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">JavaScript Code</label>
                                <textarea class="form-textarea" id="jsCode" placeholder="const data = { message: 'Hello' };&#10;console.log(JSON.stringify(data, null, 2));"></textarea>
                            </div>
                            
                            <button class="btn btn-primary" id="jsRunBtn">
                                <span class="btn-icon">‚ñ∂</span> Run JavaScript
                            </button>
                            
                            <div class="output-wrapper">
                                <div class="output-label">Output</div>
                                <div class="output-panel" id="jsOutput">Click "Run JavaScript" to execute...</div>
                                <button class="ai-analyze-btn" id="jsAiAnalyze">
                                    üîç AI Analyze Error
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- AI Chat Section -->
                <section class="section" id="ai-chat">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">AI Assistant</span>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <span>üîë</span>
                                <div><strong>API Key Required</strong> - Enter your OpenAI API key to use the AI assistant.</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">OpenAI API Key</label>
                                <input type="password" class="form-input" id="apiKey" placeholder="sk-...">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Model</label>
                                <div class="model-grid" id="modelGrid">
                                    <div class="model-card" data-model="gpt-5.1">
                                        <div class="model-name">GPT-5.1</div>
                                        <div class="model-desc">Latest flagship model</div>
                                    </div>
                                    <div class="model-card" data-model="gpt-5.2-2025-12-11">
                                        <div class="model-name">GPT-5.2 (Dec 2025)</div>
                                        <div class="model-desc">Most advanced</div>
                                    </div>
                                    <div class="model-card active" data-model="gpt-4o">
                                        <div class="model-name">GPT-4o</div>
                                        <div class="model-desc">Fast multimodal</div>
                                    </div>
                                    <div class="model-card" data-model="gpt-4">
                                        <div class="model-name">GPT-4</div>
                                        <div class="model-desc">Capable model</div>
                                    </div>
                                    <div class="model-card" data-model="gpt-3.5-turbo">
                                        <div class="model-name">GPT-3.5 Turbo</div>
                                        <div class="model-desc">Fast & cost-effective</div>
                                    </div>
                                    <div class="model-card" data-model="custom">
                                        <div class="model-name">Custom Model</div>
                                        <div class="model-desc">Enter your own</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group" id="customModelGroup" style="display:none;">
                                <label class="form-label">Custom Model Name</label>
                                <input type="text" class="form-input" id="customModelName" placeholder="e.g., gpt-4-turbo">
                            </div>
                            
                            <div class="chat-container">
                                <div class="chat-messages" id="chatMessages">
                                    <div class="chat-msg ai">
                                        <div class="chat-bubble">Hello! I'm your AI coding assistant. I can help write, debug, and improve code. What would you like to create?</div>
                                    </div>
                                </div>
                                <div class="chat-input-row">
                                    <input type="text" class="form-input" id="chatInput" placeholder="Ask me anything about code...">
                                    <button class="btn btn-primary" id="chatSendBtn">Send</button>
                                </div>
                            </div>
                            
                            <div class="btn-group">
                                <button class="btn btn-secondary" id="insertToEditorBtn">
                                    <span class="btn-icon">üìù</span> Insert to Editor
                                </button>
                                <button class="btn btn-secondary" id="clearChatBtn">
                                    <span class="btn-icon">üóë</span> Clear Chat
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Files Section -->
                <section class="section" id="files">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">File Manager</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Upload Python File</label>
                                <input type="file" class="form-input" id="fileUpload" accept=".py">
                            </div>
                            
                            <button class="btn btn-primary" id="uploadBtn">
                                <span class="btn-icon">‚¨Ü</span> Upload & Execute
                            </button>
                            
                            <hr style="border: none; border-top: 1px solid var(--border); margin: var(--space-6) 0;">
                            
                            <div class="form-group">
                                <label class="form-label">Save Editor Content As</label>
                                <input type="text" class="form-input" id="saveFilename" placeholder="script.py">
                            </div>
                            
                            <button class="btn btn-secondary" id="saveToServerBtn">
                                <span class="btn-icon">üíæ</span> Save to Server
                            </button>
                            
                            <div class="output-wrapper">
                                <div class="output-label">Status</div>
                                <div class="output-panel" id="fileOutput">File operations will appear here...</div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- API Tester Section -->
                <section class="section" id="api-test">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">API Tester</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">HTTP Method</label>
                                <select class="form-select" id="apiMethod">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">URL</label>
                                <input type="text" class="form-input" id="apiUrl" placeholder="https://api.example.com/endpoint">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Headers (JSON)</label>
                                <textarea class="form-textarea" id="apiHeaders" rows="3" placeholder='{"Authorization": "Bearer token"}'></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Body (JSON)</label>
                                <textarea class="form-textarea" id="apiBody" rows="5" placeholder='{"key": "value"}'></textarea>
                            </div>
                            
                            <button class="btn btn-primary" id="apiTestBtn">
                                <span class="btn-icon">üöÄ</span> Send Request
                            </button>
                            
                            <div class="output-wrapper">
                                <div class="output-label">Response</div>
                                <div class="output-panel" id="apiOutput">API response will appear here...</div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    <!-- Command Palette -->
    <div class="cmd-palette-overlay" id="cmdPaletteOverlay">
        <div class="cmd-palette">
            <input type="text" class="cmd-palette-input" id="cmdPaletteInput" placeholder="Type a command...">
            <div class="cmd-palette-list" id="cmdPaletteList">
                <div class="cmd-item" data-action="run">
                    <span class="cmd-item-icon">‚ñ∂</span>
                    <span class="cmd-item-label">Run Code</span>
                    <span class="cmd-item-shortcut">Enter</span>
                </div>
                <div class="cmd-item" data-action="editor">
                    <span class="cmd-item-icon">üìù</span>
                    <span class="cmd-item-label">Open Editor</span>
                </div>
                <div class="cmd-item" data-action="terminal">
                    <span class="cmd-item-icon">üíª</span>
                    <span class="cmd-item-label">Open Terminal</span>
                </div>
                <div class="cmd-item" data-action="ai-chat">
                    <span class="cmd-item-icon">ü§ñ</span>
                    <span class="cmd-item-label">Open AI Assistant</span>
                </div>
                <div class="cmd-item" data-action="preview">
                    <span class="cmd-item-icon">üëÅ</span>
                    <span class="cmd-item-label">Preview HTML</span>
                </div>
                <div class="cmd-item" data-action="analyze">
                    <span class="cmd-item-icon">üîç</span>
                    <span class="cmd-item-label">AI Analyze Last Error</span>
                </div>
                <div class="cmd-item" data-action="python">
                    <span class="cmd-item-icon">üêç</span>
                    <span class="cmd-item-label">Switch to Python</span>
                </div>
                <div class="cmd-item" data-action="javascript">
                    <span class="cmd-item-icon">üìú</span>
                    <span class="cmd-item-label">Switch to JavaScript</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Analysis Panel -->
    <div class="ai-panel-overlay" id="aiPanelOverlay"></div>
    <div class="ai-panel" id="aiPanel">
        <div class="ai-panel-header">
            <div class="ai-panel-title">
                <span>üîç</span> AI Error Analysis
            </div>
            <button class="ai-panel-close" id="aiPanelClose">√ó</button>
        </div>
        <div class="ai-panel-body" id="aiPanelBody">
            <div class="ai-section">
                <div class="ai-section-title">Error Summary</div>
                <div class="ai-section-content" id="aiErrorSummary">Analyzing...</div>
            </div>
            <div class="ai-section">
                <div class="ai-section-title">Probable Causes</div>
                <div class="ai-section-content" id="aiCauses">Loading...</div>
            </div>
            <div class="ai-section">
                <div class="ai-section-title">Suggested Fixes</div>
                <div id="aiFixes"></div>
            </div>
        </div>
        <div class="ai-panel-footer">
            <div class="ai-cmd-input">
                <input type="text" class="form-input" id="aiCmdPrompt" placeholder="Tell AI what to do...">
                <button class="btn btn-primary" id="aiCmdSubmit">Ask</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    <script>
        // ===== Global State =====
        let editor = null;
        let currentLang = 'python';
        let selectedModel = localStorage.getItem('selectedModel') || 'gpt-4o';
        let lastAIResponse = '';
        let lastError = { command: '', output: '', exitCode: 0 };
        let commandHistory = [];

        // ===== Toast Notifications =====
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.innerHTML = '<span>' + (type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ') + '</span><span>' + escapeHtml(message) + '</span>';
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // ===== Monaco Editor =====
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('monacoEditor'), {
                value: '# Python Code\nimport json\n\ndata = {"message": "Hello from HFS!"}\nprint(json.dumps(data, indent=2))',
                language: 'python',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 13,
                fontFamily: "'JetBrains Mono', monospace",
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                wordWrap: 'on',
                padding: { top: 12, bottom: 12 },
                lineNumbers: 'on',
                renderLineHighlight: 'line'
            });
        });

        // ===== Sidebar / Drawer =====
        const sidebar = document.getElementById('sidebar');
        const drawerOverlay = document.getElementById('drawerOverlay');
        const menuBtn = document.getElementById('menuBtn');
        const sidebarClose = document.getElementById('sidebarClose');

        function openSidebar() {
            sidebar.classList.add('open');
            drawerOverlay.classList.add('active');
            document.body.classList.add('drawer-open');
            sidebar.setAttribute('aria-hidden', 'false');
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            drawerOverlay.classList.remove('active');
            document.body.classList.remove('drawer-open');
            sidebar.setAttribute('aria-hidden', 'true');
        }

        menuBtn.addEventListener('click', openSidebar);
        sidebarClose.addEventListener('click', closeSidebar);
        drawerOverlay.addEventListener('click', closeSidebar);

        // Close on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeSidebar();
                closeCmdPalette();
                closeAiPanel();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                openCmdPalette();
            }
        });

        // ===== Navigation =====
        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.section');
        const pageTitle = document.getElementById('pageTitle');

        const titles = {
            'editor': 'Code Editor',
            'terminal': 'Terminal',
            'python': 'Python',
            'javascript': 'JavaScript',
            'ai-chat': 'AI Assistant',
            'files': 'Files',
            'api-test': 'API Tester'
        };

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                navItems.forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                sections.forEach(s => s.classList.remove('active'));
                document.getElementById(section).classList.add('active');
                pageTitle.textContent = titles[section] || 'HFS Code';
                if (window.innerWidth <= 768) closeSidebar();
                if (section === 'terminal') updatePwd();
            });
        });

        // ===== Language Selector =====
        const langSelector = document.getElementById('langSelector');
        const previewBtn = document.getElementById('previewBtn');
        const previewContainer = document.getElementById('previewContainer');

        const templates = {
            python: '# Python Code\nimport json\n\ndata = {"message": "Hello from HFS!"}\nprint(json.dumps(data, indent=2))',
            javascript: '// JavaScript Code\nconst data = { message: "Hello from HFS!" };\nconsole.log(JSON.stringify(data, null, 2));',
            html: '<!DOCTYPE html>\n<html>\n<head>\n    <title>Preview</title>\n    <style>body { font-family: sans-serif; padding: 20px; }</style>\n</head>\n<body>\n    <h1>Hello World!</h1>\n    <p>This is a preview.</p>\n</body>\n</html>',
            css: '/* CSS Styles */\nbody {\n    font-family: sans-serif;\n    background: #f5f5f5;\n    margin: 0;\n    padding: 20px;\n}',
            json: '{\n    "name": "HFS Code",\n    "version": "1.0.0"\n}',
            bash: '#!/bin/bash\necho "Hello from Bash!"'
        };

        langSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('segment-btn')) {
                langSelector.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentLang = e.target.dataset.lang;
                if (editor) {
                    monaco.editor.setModelLanguage(editor.getModel(), currentLang === 'bash' ? 'shell' : currentLang);
                    editor.setValue(templates[currentLang] || '');
                }
                previewBtn.style.display = currentLang === 'html' ? 'inline-flex' : 'none';
                previewContainer.style.display = 'none';
            }
        });
        // ===== API Helpers =====
        async function apiCall(endpoint, data) {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...data, admin_id: 'web-console' })
            });
            return response.json();
        }

        function setLoading(btn, loading) {
            const orig = btn.dataset.orig || btn.innerHTML;
            if (loading) {
                btn.dataset.orig = orig;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> Running...';
            } else {
                btn.disabled = false;
                btn.innerHTML = orig;
            }
        }

        function showOutput(el, text, isError = false) {
            el.textContent = text;
            el.className = 'output-panel' + (isError ? ' error' : ' success');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function detectError(output) {
            const errorPatterns = [
                /error/i, /exception/i, /traceback/i, /failed/i, /fatal/i,
                /not found/i, /undefined/i, /syntaxerror/i, /typeerror/i,
                /permission denied/i, /command not found/i
            ];
            return errorPatterns.some(p => p.test(output));
        }

        function showAiAnalyzeBtn(btnId, show) {
            const btn = document.getElementById(btnId);
            if (btn) btn.classList.toggle('visible', show);
        }

        // ===== Code Execution =====
        document.getElementById('runBtn').addEventListener('click', async () => {
            if (!editor) return;
            const code = editor.getValue();
            const btn = document.getElementById('runBtn');
            const output = document.getElementById('editorOutput');
            
            setLoading(btn, true);
            showAiAnalyzeBtn('editorAiAnalyze', false);
            
            try {
                let result;
                if (currentLang === 'python') {
                    result = await apiCall('/api/eval', { code });
                } else if (currentLang === 'javascript') {
                    result = await apiCall('/api/run-javascript', { code });
                } else if (currentLang === 'bash') {
                    result = await apiCall('/api/execute', { command: code });
                } else if (currentLang === 'html') {
                    showPreview();
                    setLoading(btn, false);
                    return;
                } else if (currentLang === 'json') {
                    try {
                        const parsed = JSON.parse(code);
                        showOutput(output, JSON.stringify(parsed, null, 2));
                    } catch (e) {
                        showOutput(output, 'Invalid JSON: ' + e.message, true);
                        showAiAnalyzeBtn('editorAiAnalyze', true);
                        lastError = { command: 'JSON parse', output: e.message, exitCode: 1 };
                    }
                    setLoading(btn, false);
                    return;
                } else {
                    showOutput(output, 'Language not supported for execution', true);
                    setLoading(btn, false);
                    return;
                }
                
                const isError = !result.success || detectError(result.output || result.error);
                showOutput(output, result.success ? result.output : result.error, isError);
                
                if (isError) {
                    showAiAnalyzeBtn('editorAiAnalyze', true);
                    lastError = { command: currentLang + ' code', output: result.error || result.output, exitCode: result.return_code || 1 };
                    commandHistory.push({ cmd: currentLang, output: result.output || result.error });
                }
            } catch (err) {
                showOutput(output, 'Error: ' + err.message, true);
                showAiAnalyzeBtn('editorAiAnalyze', true);
                lastError = { command: currentLang, output: err.message, exitCode: 1 };
            } finally {
                setLoading(btn, false);
            }
        });

        // ===== HTML Preview =====
        function showPreview() {
            if (!editor) return;
            const code = editor.getValue();
            const frame = document.getElementById('previewFrame');
            previewContainer.style.display = 'block';
            frame.srcdoc = code;
        }
        
        document.getElementById('previewBtn').addEventListener('click', showPreview);

        // ===== Download & Clear =====
        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (!editor) return;
            const code = editor.getValue();
            const ext = { python: 'py', javascript: 'js', html: 'html', css: 'css', json: 'json', bash: 'sh' };
            const blob = new Blob([code], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'code.' + (ext[currentLang] || 'txt');
            a.click();
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            if (editor) editor.setValue('');
        });

        document.getElementById('copyCodeBtn').addEventListener('click', () => {
            if (!editor) return;
            navigator.clipboard.writeText(editor.getValue());
            showToast('Code copied to clipboard', 'success');
        });
        // ===== Terminal =====
        async function updatePwd() {
            try {
                const response = await fetch('/api/pwd');
                const data = await response.json();
                if (data.success) {
                    document.getElementById('terminalPwd').textContent = data.cwd;
                }
            } catch (e) {
                document.getElementById('terminalPwd').textContent = 'Unknown';
            }
        }

        document.getElementById('terminalRunBtn').addEventListener('click', async () => {
            const input = document.getElementById('terminalInput');
            const output = document.getElementById('terminalOutput');
            const btn = document.getElementById('terminalRunBtn');
            const command = input.value.trim();
            
            if (!command) return;
            
            setLoading(btn, true);
            showAiAnalyzeBtn('terminalAiAnalyze', false);
            commandHistory.push({ cmd: command });
            
            try {
                const result = await apiCall('/api/execute', { command });
                const isError = !result.success || detectError(result.output || result.error);
                showOutput(output, result.success ? result.output : result.error, isError);
                
                if (result.success) updatePwd();
                
                if (isError) {
                    showAiAnalyzeBtn('terminalAiAnalyze', true);
                    lastError = { command, output: result.error || result.output, exitCode: result.return_code || 1 };
                }
            } catch (err) {
                showOutput(output, 'Error: ' + err.message, true);
                showAiAnalyzeBtn('terminalAiAnalyze', true);
                lastError = { command, output: err.message, exitCode: 1 };
            } finally {
                setLoading(btn, false);
            }
        });

        document.getElementById('terminalInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') document.getElementById('terminalRunBtn').click();
        });

        // ===== Python =====
        document.getElementById('pythonRunBtn').addEventListener('click', async () => {
            const code = document.getElementById('pythonCode').value.trim();
            const output = document.getElementById('pythonOutput');
            const btn = document.getElementById('pythonRunBtn');
            
            if (!code) return;
            
            setLoading(btn, true);
            showAiAnalyzeBtn('pythonAiAnalyze', false);
            
            try {
                const result = await apiCall('/api/eval', { code });
                const isError = !result.success || detectError(result.output || result.error);
                showOutput(output, result.success ? result.output : result.error, isError);
                
                if (isError) {
                    showAiAnalyzeBtn('pythonAiAnalyze', true);
                    lastError = { command: 'python', output: result.error || result.output, exitCode: 1 };
                }
            } catch (err) {
                showOutput(output, 'Error: ' + err.message, true);
                showAiAnalyzeBtn('pythonAiAnalyze', true);
            } finally {
                setLoading(btn, false);
            }
        });

        // ===== JavaScript =====
        document.getElementById('jsRunBtn').addEventListener('click', async () => {
            const code = document.getElementById('jsCode').value.trim();
            const output = document.getElementById('jsOutput');
            const btn = document.getElementById('jsRunBtn');
            
            if (!code) return;
            
            setLoading(btn, true);
            showAiAnalyzeBtn('jsAiAnalyze', false);
            
            try {
                const result = await apiCall('/api/run-javascript', { code });
                const isError = !result.success || detectError(result.output || result.error);
                showOutput(output, result.success ? result.output : result.error, isError);
                
                if (isError) {
                    showAiAnalyzeBtn('jsAiAnalyze', true);
                    lastError = { command: 'node', output: result.error || result.output, exitCode: 1 };
                }
            } catch (err) {
                showOutput(output, 'Error: ' + err.message, true);
                showAiAnalyzeBtn('jsAiAnalyze', true);
            } finally {
                setLoading(btn, false);
            }
        });
        // ===== Model Selection =====
        const modelGrid = document.getElementById('modelGrid');
        const customModelGroup = document.getElementById('customModelGroup');

        // Restore saved model
        document.querySelectorAll('.model-card').forEach(card => {
            if (card.dataset.model === selectedModel) {
                card.classList.add('active');
                if (selectedModel === 'custom') {
                    customModelGroup.style.display = 'block';
                }
            } else {
                card.classList.remove('active');
            }
        });

        modelGrid.addEventListener('click', (e) => {
            const card = e.target.closest('.model-card');
            if (!card) return;
            
            modelGrid.querySelectorAll('.model-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            selectedModel = card.dataset.model;
            localStorage.setItem('selectedModel', selectedModel);
            customModelGroup.style.display = selectedModel === 'custom' ? 'block' : 'none';
        });

        // ===== AI Chat =====
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const apiKey = document.getElementById('apiKey').value.trim();
            const messagesDiv = document.getElementById('chatMessages');
            const btn = document.getElementById('chatSendBtn');
            const prompt = input.value.trim();
            
            if (!prompt) return;
            if (!apiKey) {
                showToast('Please enter your OpenAI API key', 'warning');
                return;
            }
            
            // Add user message
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-msg user';
            userMsg.innerHTML = '<div class="chat-bubble">' + escapeHtml(prompt) + '</div>';
            messagesDiv.appendChild(userMsg);
            input.value = '';
            
            // Add loading
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'chat-msg ai';
            loadingMsg.innerHTML = '<div class="chat-bubble"><span class="spinner" style="border-color: var(--text-muted); border-top-color: var(--text-primary);"></span> Thinking...</div>';
            messagesDiv.appendChild(loadingMsg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            setLoading(btn, true);
            
            try {
                const model = selectedModel === 'custom' 
                    ? document.getElementById('customModelName').value.trim() || 'gpt-4o'
                    : selectedModel;
                
                const result = await apiCall('/api/ai-chat', { 
                    prompt, 
                    api_key: apiKey,
                    model
                });
                
                messagesDiv.removeChild(loadingMsg);
                
                const aiMsg = document.createElement('div');
                aiMsg.className = 'chat-msg ai';
                
                if (result.success) {
                    aiMsg.innerHTML = '<div class="chat-bubble">' + formatAIResponse(result.response) + '</div>';
                    lastAIResponse = result.response;
                    
                    // Show toast if fallback model was used
                    if (result.model_used && result.model_used !== model) {
                        showToast('Model unavailable, switched to ' + result.model_used, 'warning');
                    }
                } else {
                    aiMsg.innerHTML = '<div class="chat-bubble" style="color: var(--error);">Error: ' + escapeHtml(result.error) + '</div>';
                    
                    // If model not available, suggest fallback
                    if (result.error && result.error.toLowerCase().includes('model')) {
                        showToast('Model unavailable, try GPT-4o or GPT-3.5', 'warning');
                    }
                }
                
                messagesDiv.appendChild(aiMsg);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (err) {
                messagesDiv.removeChild(loadingMsg);
                const errMsg = document.createElement('div');
                errMsg.className = 'chat-msg ai';
                errMsg.innerHTML = '<div class="chat-bubble" style="color: var(--error);">Error: ' + escapeHtml(err.message) + '</div>';
                messagesDiv.appendChild(errMsg);
            } finally {
                setLoading(btn, false);
            }
        }

        function formatAIResponse(text) {
            let html = escapeHtml(text);
            // Code blocks
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre style="background: var(--bg-primary); padding: 10px; border-radius: 6px; overflow-x: auto; margin: 8px 0; font-size: 12px;"><code>$2</code></pre>');
            // Inline code
            html = html.replace(/`([^`]+)`/g, '<code style="background: var(--bg-primary); padding: 2px 5px; border-radius: 3px; font-size: 12px;">$1</code>');
            // Line breaks
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        document.getElementById('chatSendBtn').addEventListener('click', sendChatMessage);
        document.getElementById('chatInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });

        document.getElementById('insertToEditorBtn').addEventListener('click', () => {
            if (!lastAIResponse || !editor) return;
            const codeMatch = lastAIResponse.match(/```[\w]*\n([\s\S]*?)```/);
            editor.setValue(codeMatch ? codeMatch[1].trim() : lastAIResponse);
            document.querySelector('[data-section="editor"]').click();
            showToast('Code inserted into editor', 'success');
        });

        document.getElementById('clearChatBtn').addEventListener('click', () => {
            document.getElementById('chatMessages').innerHTML = '<div class="chat-msg ai"><div class="chat-bubble">Hello! I\'m your AI coding assistant. I can help write, debug, and improve code. What would you like to create?</div></div>';
            lastAIResponse = '';
        });
        // ===== Files =====
        document.getElementById('uploadBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('fileUpload');
            const output = document.getElementById('fileOutput');
            const btn = document.getElementById('uploadBtn');
            
            if (!fileInput.files || !fileInput.files[0]) {
                showOutput(output, 'Please select a file', true);
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('admin_id', 'web-console');
            
            setLoading(btn, true);
            
            try {
                const response = await fetch('/api/run-file', { method: 'POST', body: formData });
                const result = await response.json();
                showOutput(output, result.success ? result.output : result.error, !result.success);
            } catch (err) {
                showOutput(output, 'Error: ' + err.message, true);
            } finally {
                setLoading(btn, false);
            }
        });

        document.getElementById('saveToServerBtn').addEventListener('click', async () => {
            const filename = document.getElementById('saveFilename').value.trim();
            const output = document.getElementById('fileOutput');
            
            if (!filename) {
                showOutput(output, 'Please enter a filename', true);
                return;
            }
            if (!editor) return;
            
            try {
                const result = await apiCall('/api/save-file', { 
                    filename, 
                    content: editor.getValue() 
                });
                showOutput(output, result.success ? 'Saved: ' + result.path : result.error, !result.success);
            } catch (err) {
                showOutput(output, 'Error: ' + err.message, true);
            }
        });

        // ===== API Tester =====
        document.getElementById('apiTestBtn').addEventListener('click', async () => {
            const method = document.getElementById('apiMethod').value;
            const url = document.getElementById('apiUrl').value.trim();
            const output = document.getElementById('apiOutput');
            const btn = document.getElementById('apiTestBtn');
            
            if (!url) {
                showOutput(output, 'Please enter a URL', true);
                return;
            }
            
            setLoading(btn, true);
            
            try {
                const result = await apiCall('/api/test-api', {
                    method,
                    url,
                    headers: document.getElementById('apiHeaders').value,
                    body: document.getElementById('apiBody').value
                });
                
                if (result.success) {
                    try {
                        const json = JSON.parse(result.response);
                        showOutput(output, JSON.stringify(json, null, 2));
                    } catch {
                        showOutput(output, result.response);
                    }
                } else {
                    showOutput(output, result.error, true);
                }
            } catch (err) {
                showOutput(output, 'Error: ' + err.message, true);
            } finally {
                setLoading(btn, false);
            }
        });

        // ===== Toolbar AI Features =====
        async function toolbarAI(action) {
            if (!editor) return;
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showToast('Please enter your OpenAI API key in AI Assistant', 'warning');
                return;
            }
            
            const code = editor.getValue();
            const prompts = {
                explain: 'Explain this code in simple terms:\n\n' + code,
                optimize: 'Optimize this code for better performance and readability. Return only the improved code:\n\n' + code,
                comments: 'Add helpful comments to this code. Return the code with comments:\n\n' + code,
                tests: 'Generate unit tests for this code:\n\n' + code
            };
            
            showToast('AI is processing...', 'info');
            
            try {
                const model = selectedModel === 'custom' 
                    ? document.getElementById('customModelName').value.trim() || 'gpt-4o'
                    : selectedModel;
                    
                const result = await apiCall('/api/ai-chat', {
                    prompt: prompts[action],
                    api_key: apiKey,
                    model
                });
                
                if (result.success) {
                    if (action === 'explain') {
                        showOutput(document.getElementById('editorOutput'), result.response);
                    } else {
                        const codeMatch = result.response.match(/```[\w]*\n([\s\S]*?)```/);
                        if (codeMatch) {
                            editor.setValue(codeMatch[1].trim());
                        } else {
                            editor.setValue(result.response);
                        }
                    }
                    showToast('AI completed: ' + action, 'success');
                } else {
                    showToast('AI error: ' + result.error, 'error');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        }

        document.getElementById('explainBtn').addEventListener('click', () => toolbarAI('explain'));
        document.getElementById('optimizeBtn').addEventListener('click', () => toolbarAI('optimize'));
        document.getElementById('commentsBtn').addEventListener('click', () => toolbarAI('comments'));
        document.getElementById('testsBtn').addEventListener('click', () => toolbarAI('tests'));
        // ===== Command Palette =====
        const cmdPaletteOverlay = document.getElementById('cmdPaletteOverlay');
        const cmdPaletteInput = document.getElementById('cmdPaletteInput');

        function openCmdPalette() {
            cmdPaletteOverlay.classList.add('active');
            cmdPaletteInput.value = '';
            cmdPaletteInput.focus();
        }

        function closeCmdPalette() {
            cmdPaletteOverlay.classList.remove('active');
        }

        document.getElementById('cmdPaletteBtn').addEventListener('click', openCmdPalette);
        cmdPaletteOverlay.addEventListener('click', (e) => {
            if (e.target === cmdPaletteOverlay) closeCmdPalette();
        });

        document.querySelectorAll('.cmd-item').forEach(item => {
            item.addEventListener('click', () => {
                const action = item.dataset.action;
                closeCmdPalette();
                
                switch(action) {
                    case 'run':
                        document.getElementById('runBtn').click();
                        break;
                    case 'editor':
                    case 'terminal':
                    case 'ai-chat':
                        document.querySelector('[data-section="' + action + '"]').click();
                        break;
                    case 'preview':
                        showPreview();
                        break;
                    case 'analyze':
                        openAiPanel();
                        break;
                    case 'python':
                        document.querySelector('[data-lang="python"]').click();
                        break;
                    case 'javascript':
                        document.querySelector('[data-lang="javascript"]').click();
                        break;
                }
            });
        });

        // Filter commands
        cmdPaletteInput.addEventListener('input', () => {
            const query = cmdPaletteInput.value.toLowerCase();
            document.querySelectorAll('.cmd-item').forEach(item => {
                const label = item.querySelector('.cmd-item-label').textContent.toLowerCase();
                item.style.display = label.includes(query) ? 'flex' : 'none';
            });
        });

        // ===== AI Analysis Panel =====
        const aiPanelOverlay = document.getElementById('aiPanelOverlay');
        const aiPanel = document.getElementById('aiPanel');

        function openAiPanel() {
            aiPanelOverlay.classList.add('active');
            aiPanel.classList.add('open');
            document.body.classList.add('drawer-open');
            analyzeError();
        }

        function closeAiPanel() {
            aiPanelOverlay.classList.remove('active');
            aiPanel.classList.remove('open');
            document.body.classList.remove('drawer-open');
        }

        document.getElementById('aiPanelClose').addEventListener('click', closeAiPanel);
        aiPanelOverlay.addEventListener('click', closeAiPanel);

        // AI Analyze buttons
        ['editorAiAnalyze', 'terminalAiAnalyze', 'pythonAiAnalyze', 'jsAiAnalyze'].forEach(id => {
            document.getElementById(id).addEventListener('click', openAiPanel);
        });

        async function analyzeError() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const summaryEl = document.getElementById('aiErrorSummary');
            const causesEl = document.getElementById('aiCauses');
            const fixesEl = document.getElementById('aiFixes');
            
            if (!apiKey) {
                summaryEl.textContent = 'Please enter your OpenAI API key in AI Assistant to analyze errors.';
                causesEl.textContent = '';
                fixesEl.innerHTML = '';
                return;
            }
            
            summaryEl.innerHTML = '<div class="skeleton" style="height: 40px;"></div>';
            causesEl.innerHTML = '<div class="skeleton" style="height: 60px;"></div>';
            fixesEl.innerHTML = '<div class="skeleton" style="height: 80px;"></div>';
            
            const context = {
                command: lastError.command,
                output: lastError.output,
                exitCode: lastError.exitCode,
                recentCommands: commandHistory.slice(-10).map(c => c.cmd).join('\n'),
                language: currentLang
            };
            
            const prompt = `Analyze this error and provide:
1. A brief plain-English summary of what went wrong
2. 2-3 probable causes
3. 2-3 suggested fix commands (shell commands that could fix this)

Context:
- Command/Code: ${context.command}
- Error Output: ${context.output}
- Exit Code: ${context.exitCode}
- Language: ${context.language}
- Recent Commands: ${context.recentCommands}

Format your response as JSON:
{
  "summary": "brief explanation",
  "causes": ["cause1", "cause2"],
  "fixes": [
    {"command": "fix command", "description": "what it does", "risk": "safe|medium|risky"}
  ]
}`;

            try {
                const model = selectedModel === 'custom' 
                    ? document.getElementById('customModelName').value.trim() || 'gpt-4o'
                    : selectedModel;
                    
                const result = await apiCall('/api/ai-chat', {
                    prompt,
                    api_key: apiKey,
                    model
                });
                
                if (result.success) {
                    try {
                        // Extract JSON from response
                        const jsonMatch = result.response.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const analysis = JSON.parse(jsonMatch[0]);
                            summaryEl.textContent = analysis.summary || 'Unable to analyze';
                            causesEl.innerHTML = (analysis.causes || []).map(c => '‚Ä¢ ' + escapeHtml(c)).join('<br>');
                            fixesEl.innerHTML = (analysis.fixes || []).map(f => 
                                '<div class="ai-fix-cmd" data-cmd="' + escapeHtml(f.command) + '">' +
                                '<span class="ai-fix-cmd-text">' + escapeHtml(f.command) + '</span>' +
                                '<span class="risk-badge risk-' + (f.risk || 'safe') + '">' + (f.risk || 'safe') + '</span>' +
                                '<span class="ai-fix-cmd-run">‚ñ∂ Run</span>' +
                                '</div>'
                            ).join('');
                            
                            // Add click handlers for fix commands
                            fixesEl.querySelectorAll('.ai-fix-cmd').forEach(el => {
                                el.addEventListener('click', () => {
                                    const cmd = el.dataset.cmd;
                                    document.getElementById('terminalInput').value = cmd;
                                    closeAiPanel();
                                    document.querySelector('[data-section="terminal"]').click();
                                    showToast('Command ready to execute', 'info');
                                });
                            });
                        } else {
                            summaryEl.textContent = result.response;
                            causesEl.textContent = '';
                            fixesEl.innerHTML = '';
                        }
                    } catch (e) {
                        summaryEl.textContent = result.response;
                        causesEl.textContent = '';
                        fixesEl.innerHTML = '';
                    }
                } else {
                    summaryEl.textContent = 'Error: ' + result.error;
                    causesEl.textContent = '';
                    fixesEl.innerHTML = '';
                }
            } catch (err) {
                summaryEl.textContent = 'Error: ' + err.message;
                causesEl.textContent = '';
                fixesEl.innerHTML = '';
            }
        }

        // AI Command Input
        document.getElementById('aiCmdSubmit').addEventListener('click', async () => {
            const input = document.getElementById('aiCmdPrompt');
            const prompt = input.value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!prompt || !apiKey) return;
            
            const fixesEl = document.getElementById('aiFixes');
            fixesEl.innerHTML = '<div class="skeleton" style="height: 60px;"></div>';
            
            try {
                const model = selectedModel === 'custom' 
                    ? document.getElementById('customModelName').value.trim() || 'gpt-4o'
                    : selectedModel;
                    
                const result = await apiCall('/api/ai-chat', {
                    prompt: 'Based on this request, suggest shell commands: ' + prompt + '\n\nContext: ' + lastError.output + '\n\nReturn JSON: {"fixes": [{"command": "cmd", "description": "desc", "risk": "safe|medium|risky"}]}',
                    api_key: apiKey,
                    model
                });
                
                if (result.success) {
                    const jsonMatch = result.response.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const data = JSON.parse(jsonMatch[0]);
                        fixesEl.innerHTML = (data.fixes || []).map(f => 
                            '<div class="ai-fix-cmd" data-cmd="' + escapeHtml(f.command) + '">' +
                            '<span class="ai-fix-cmd-text">' + escapeHtml(f.command) + '</span>' +
                            '<span class="risk-badge risk-' + (f.risk || 'safe') + '">' + (f.risk || 'safe') + '</span>' +
                            '<span class="ai-fix-cmd-run">‚ñ∂ Run</span>' +
                            '</div>'
                        ).join('');
                        
                        fixesEl.querySelectorAll('.ai-fix-cmd').forEach(el => {
                            el.addEventListener('click', () => {
                                document.getElementById('terminalInput').value = el.dataset.cmd;
                                closeAiPanel();
                                document.querySelector('[data-section="terminal"]').click();
                            });
                        });
                    }
                }
            } catch (err) {
                fixesEl.innerHTML = '<div style="color: var(--error);">Error: ' + escapeHtml(err.message) + '</div>';
            }
            
            input.value = '';
        });

        // ===== Initialize =====
        document.addEventListener('DOMContentLoaded', () => {
            updatePwd();
            
            // Restore API key if saved
            const savedApiKey = localStorage.getItem('openai_api_key');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }
            
            // Save API key on change
            document.getElementById('apiKey').addEventListener('change', (e) => {
                localStorage.setItem('openai_api_key', e.target.value);
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    closeSidebar();
                }
            });
        });
    </script>
</body>
</html>
